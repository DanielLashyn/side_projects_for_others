'' Daniel Lashyn November 2025


Const CLIENT_DATA_FOLDER As String = "data"

Public GlobalSheets As Collection
Public GarmanWorkBook As Workbook

'' TODO
'' - createsheet:
    '' Add condition to handle if a sheet already has that name
    '' Have way to find end of Row
'' Check hardvalues
'' add formating to the Summary and Z Value Cells



Sub main()

    Dim clientFiles() As String
    Dim curFileName As String
    Dim curSheet As Worksheet
    Dim lastRow As Long
    Dim savedRow As Long
    
    
    
    
    init
    ''createSheet
    
    clientFiles = GetFileInDirectory
    
    curFileName = ActiveWorkbook.Path & "\" & CLIENT_DATA_FOLDER & "\" & clientFiles(0)
    
    
    Set curSheet = Worksheets("Sort Data")
    
    
    '' Loads the garmin data in the newly created sheet
    loadGarminData curFileName, curSheet
    
           
    addCustomHeaders curSheet
    '' adds the info runner info
    

    '' adds Steptype and interval number info
    setStepType curSheet
    setIntervalNum curSheet
    
    lastRow = 0
    
    '' create the rest data
     createStepTables "Recovery", curSheet, 18, 4, lastRow
     createAverages curSheet, 4 + 1, lastRow, 18, 30
     

          
    '' create the run data
    savedRow = lastRow + 4
    createStepTables "Run", curSheet, 18, savedRow, lastRow
    createAverages curSheet, savedRow + 1, lastRow, 18, 30
    createZValue curSheet, savedRow + 1, lastRow, 18, 30
    '' create chart for each table
    
    
   

End Sub
Sub init()
    Set GarmanWorkBook = ActiveWorkbook
    Set GlobalSheets = New Collection
End Sub
Sub createSheet()
    Dim curws As Worksheet
    
    Dim wsNames As Variant
    Dim i As Integer
    
    wsNames = Array("Sort Data")
    
    For i = LBound(wsNames) To UBound(wsNames)
    
        Set curws = GarmanWorkBook.Worksheets.Add(After:=GarmanWorkBook.Worksheets(GarmanWorkBook.Worksheets.count))
        curws.Name = wsNames(i)
    
    GlobalSheets.Add curws, wsNames(i)
    Next i
    
End Sub
' Gets the name of all the .csv files in the CLIENT_DATA_FOLDER'
Function GetFileInDirectory() As Variant
    Dim selectedDir As String
    Dim fileName As String
    Dim files() As String
    Dim count As Integer
    
    selectedDir = ActiveWorkbook.Path & "\" & CLIENT_DATA_FOLDER & "\"
    
    
    fileName = Dir(selectedDir & "*.csv")
    
    
    count = 0
    
    Do While fileName <> ""
        ReDim Preserve files(count)
        files(count) = fileName
        count = count + 1
        fileName = Dir
    Loop
    
    'Ends the program if there were no .xlsx files found in the the CLIENT_DATA_FOLDER'
    If count <= 0 Then
        MsgBox "Add .xlsx files to " & CLIENT_DATA_FOLDER, vbOKOnly, "Error: No .xls found"
        End
    End If
        
    GetFileInDirectory = files
End Function

Sub loadGarminData(filePath As String, destWS As Worksheet)
    Dim srcCSV As Workbook
    Dim srcCSVws As Worksheet
    Dim allowedCols As Variant
    Dim col, csvLastCol, csv, lastRow, nextDestCol As Long
    Dim Header As String
    
    
    
    Set srcCSV = Workbooks.Open(fileName:=filePath)
    Set srcCSVws = srcCSV.Sheets(1)
    
    csvLastCol = srcCSVws.Cells(1, srcCSVws.Columns.count).End(xlToLeft).Column
    
    
    
    allowedCols = Array("Interval", "Step Type", "Time", "Distance", "Avg Pace", "Best Pace", "Avg HR", "Max HR", "Avg Run Cadence", "Max Run Cadence", "Avg Stride Length", "Avg Vertical Oscillation", "Avg Vertical Ratio")
    nextDestCol = destWS.Range("D4").Column
    
    ' Loop all source CSV columns
    For col = 1 To csvLastCol
        Header = srcCSVws.Cells(1, col).Value
        
        If IsInArray(Header, allowedCols) Then
            ' Copy the entire column to next available destination col
            
            csvLastRow = srcCSVws.Cells(srcCSVws.Rows.count, col).End(xlUp).row
            srcCSVws.Range(srcCSVws.Cells(1, col), srcCSVws.Cells(csvLastRow, col)).Copy _
        destWS.Cells(4, nextDestCol)
            nextDestCol = nextDestCol + 1
        End If
    Next col

    ' Copy all used data from the CSV
    ''srcCSV.Sheets(1).UsedRange.Copy destWS.Range("D4")
    
    
    
    

    ' Close CSV without saving
    srcCSV.Close SaveChanges:=False
      
End Sub

Sub addCustomHeaders(selectedSheet As Worksheet)

    selectedSheet.Range("A1").Value = "Date"
    selectedSheet.Range("B1").Value = "Type of Work-Out"
    selectedSheet.Range("C1").Value = "Work Interval Time (s)"
    selectedSheet.Range("D1").Value = "Work Interval Distance (m)"
    selectedSheet.Range("E1").Value = "Work Interval Pace (min/km)"
    selectedSheet.Range("F1").Value = "Rep Break (s)"
    
    '' Adds the data sorted data header
    selectedSheet.Range("B4").Value = "Interval"
    selectedSheet.Range("C4").Value = "Step Type"
    
End Sub
Sub setStepType(selSheet As Worksheet)
        
    Dim threshold As Date
    Dim lastRow, headerRow, curRow, selCol As Long
    Dim cellVal As String
    
    Dim t As Date
    
        
    threshold = TimeValue("07:00:00") '' threshold is 7 mins
    
    selCol = 6
    headerRow = 4
    lastRow = selSheet.Cells(selSheet.Rows.count, "F").End(xlUp).row '' CHANGE from being hardcoded
    
    
    For curRow = headerRow + 1 To lastRow - 1
        cellVal = selSheet.Cells(curRow, selCol).Value
        
        t = CDate(CDbl(cellVal))
        
        If IsDate(t) Then
            If TimeValue(t) < threshold Then
            selSheet.Cells(curRow, 3).Value = "Run"
            
        Else
            selSheet.Cells(curRow, 3).Value = "Recovery"
        End If
        
    End If
        
    Next curRow

End Sub

Sub setIntervalNum(selSheet As Worksheet)
    Dim lastRow, curRow, headerRow, counter As Long
    
    headerRow = 4
    counter = 0
    
    lastRow = selSheet.Cells(selSheet.Rows.count, "C").End(xlUp).row
    
    For curRow = headerRow + 1 To lastRow
    
        If (selSheet.Cells(curRow, 3).Value = "Run") Then
            counter = counter + 1
        End If
        selSheet.Cells(curRow, 2).Value = counter

    Next curRow

End Sub
Sub createStepTables(stepType As String, selSheet As Worksheet, startCol As Long, startRow As Long, ByRef finalRow As Long)
    Dim lastRow, curRow, headerRow, stepRow As Long
    
    
    stepRow = startRow + 1
    headerRow = 4
    lastRow = selSheet.Cells(selSheet.Rows.count, "C").End(xlUp).row
    
    
    selSheet.Range("B4:N4").Copy Destination:=selSheet.Cells(startRow, startCol)
    
    For curRow = headerRow + 1 To lastRow
        If (selSheet.Cells(curRow, "C").Value = stepType) Then
            selSheet.Range(selSheet.Cells(curRow, "B"), _
               selSheet.Cells(curRow, "N")).Copy _
               Destination:=selSheet.Cells(stepRow, startCol)
            stepRow = stepRow + 1
        End If
           
    
    Next curRow
    
    finalRow = stepRow
    
End Sub
Sub createAverages(selSheet As Worksheet, startRow As Long, endRow As Long, startColumn As Long, endColumn As Long)
    Dim i As Long
    
    
    selSheet.Cells(endRow, startColumn).Value = "AVERAGES"
   
    For i = startColumn + 2 To endColumn
        ''selSheet.Cells(endRow, i).FormulaR1C1 = "=AVERAGE(R[-29]C:R[-1]C)"
        
        selSheet.Cells(endRow, i).FormulaR1C1 = _
        "=AVERAGE(R" & startRow & "C" & i & ":R" & endRow - 1 & "C" & i & ")"
    Next i

End Sub
Sub createZValue(selSheet As Worksheet, startRow As Long, endRow As Long, startColumn As Long, endColumn As Long)
    
    selSheet.Cells(endRow + 1, startColumn).Value = "STANDARD DEVIATIONS"
    For i = startColumn + 2 To endColumn
        ''selSheet.Cells(endRow, i).FormulaR1C1 = "=AVERAGE(R[-29]C:R[-1]C)"
        
        selSheet.Cells(endRow + 1, i).FormulaR1C1 = _
        "=STDEV(R" & startRow & "C" & i & ":R" & endRow - 1 & "C" & i & ")"
    Next i

End Sub


Sub sortDataSheet()
    Dim headers() As Variant
    headers = Array("Interval", "Step Type", "Time", "Distance", "Avg Pace", "Best Pace", "Avg HR", "Max HR", "Avg Run Cadence", "Max Run Cadence", "Avg Stride Length", "Avg Vertical Oscillation", "Avg Vertical Ratio")
    
    copyData "Sheet1", "Sort Data", headers
       
End Sub

Sub recoveryDataSheet()
    Dim headers() As Variant
    Dim colNum As Integer
    
    Dim rdSheet As Worksheet
    Dim lastRow, i As Long
    
    Set rdSheet = Worksheets("Recovery Data")
        
    headers = Array("Interval", "Step Type", "Time", "Distance", "Avg Pace", "Best Pace", "Avg HR", "Max HR", "Avg Run Cadence", "Max Run Cadence", "Avg Stride Length", "Avg Vertical Oscillation", "Avg Vertical Ratio")
    
    copyData "Sheet1", "Recovery Data", headers
    
    colNum = -1
    
    colNum = Application.Match("Step Type", rdSheet.Rows(1), 0)
    
    '' Checks that it was able to find the column
    If colNum = -1 Then GoTo EndSection
        
    lastRow = rdSheet.Cells(rdSheet.Rows.count, colNum).End(xlUp).row
    
    For i = lastRow - 1 To 2 Step -2
        rdSheet.Rows(i).Delete
    Next i
    
EndSection:

End Sub
Sub ranDataSheet()
    Dim headers() As Variant
    Dim colNum As Integer
    
    Dim rdSheet As Worksheet
    Dim lastRow, i As Long
    
    Set rdSheet = Worksheets("Run Data")
        
    headers = Array("Interval", "Step Type", "Time", "Distance", "Avg Pace", "Best Pace", "Avg HR", "Max HR", "Avg Run Cadence", "Max Run Cadence", "Avg Stride Length", "Avg Vertical Oscillation", "Avg Vertical Ratio")
    
    copyData "Sheet1", "Run Data", headers
    
    colNum = -1
    
    colNum = Application.Match("Step Type", rdSheet.Rows(1), 0)
    
    '' Checks that it was able to find the column
    If colNum = -1 Then GoTo EndSection
        
    lastRow = rdSheet.Cells(rdSheet.Rows.count, colNum).End(xlUp).row
    
    For i = lastRow To 2 Step -2
        
        rdSheet.Rows(i).Delete
    
    
    Next i
        
    
    
EndSection:

End Sub

Sub createChartSheet()

End Sub
Sub copyData(srcName As String, dstName As String, colNames() As Variant)

    Dim srcWS, dstws As Worksheet
    Dim headerName As String
    Dim orgColNum, i As Integer
    Dim lastRow As Long
    
    '' Note this is the order of the columns

    Set srcWS = Worksheets(srcName)
    Set dstws = Worksheets(dstName) ''GlobalSheets("Sort Data")
    
      
    For i = LBound(colNames) To UBound(colNames)
        headerName = colNames(i)
        orgColNum = -1
        
        ' --- Find the column number by header (first row) ---
        ' Note .Match is case insensitive
        orgColNum = Application.Match(headerName, srcWS.Rows(1), 0)
        
        ' Checks that it was able to find it'
        If (orgColNum <> -1) Then

        ' --- Find last used row in that column ---
        lastRow = srcWS.Cells(srcWS.Rows.count, orgColNum).End(xlUp).row
        
        ' Copy the column to destination sheet
        srcWS.Range(srcWS.Cells(1, orgColNum), srcWS.Cells(lastRow, orgColNum)).Copy _
                Destination:=dstws.Cells(1, i + 1)
                
        End If
           
   Next i
    
    '' Removes the last row if it's a summary row
        
    lastRow = dstws.Cells(dstws.Rows.count, 1).End(xlUp).row
    If (dstws.Cells(lastRow, 1).Value = "Summary") Then
        dstws.Rows(lastRow).Delete
    End If

End Sub
Function IsInArray(val As String, arr As Variant) As Boolean
    Dim i As Long
    For i = LBound(arr) To UBound(arr)
        If StrComp(val, arr(i), vbTextCompare) = 0 Then
            IsInArray = True
            Exit Function
        End If
    Next i
End Function

