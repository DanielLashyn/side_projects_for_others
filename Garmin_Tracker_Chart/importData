'' Daniel Lashyn November 2025
Const CLIENT_DATA_FOLDER As String = "data"

Public SORT_DATA_HEADING_ROW As Integer

Public SORT_DATA_FILE_NAME_COL As Integer
Public SORT_DATA_DATE_COL As Integer
Public SORT_DATA_STEP_TYPE_COL As Integer
Public SORT_DATA_INTERVAL_COL As Integer
Public SORT_DATA_IMPORT_DATA_COL As Integer

Public IMPORT_HEADERS As Variant

Public startingInputRow As Long
Public totalImportRows As Long

Public GlobalSheets As Collection
Public GarmanWorkBook As Workbook
Sub importDataMain()

    Dim clientFiles() As String
    Dim curFileName As String
    Dim curSheet As Worksheet
    
    
    Init
    ''createSheet
    Set curSheet = Worksheets("Sort Data")
        
    DisplayHeaders curSheet
    
    startingInputRow = curSheet.Cells(curSheet.Rows.count, 1).End(xlUp).Row + 1
    
    clientFiles = GetFileInDirectory(CLIENT_DATA_FOLDER)
    
    curFileName = ActiveWorkbook.Path & "\" & CLIENT_DATA_FOLDER & "\" & clientFiles(0)
    
    '' Loads the garmin data in the newly created sheet
    loadGarminData curFileName, curSheet
      

    '' adds Steptype and interval number info
    setStepType curSheet
    setIntervalNum curSheet
    SetFileNameColumn curSheet, clientFiles(0)
    SetDateColumn curSheet, "Jan 14th, 2025"
    
   
    ''CreateMultiLineChart curSheet
    clearMyTable curSheet
    createTable curSheet, CLng(SORT_DATA_HEADING_ROW), CLng(SORT_DATA_FILE_NAME_COL), 0, "SortDataTable"
    
    FormatColumnDecimalsRange curSheet, 6, 15, 2
    FormatRunnerTime curSheet, "Time"
    FormatRunnerTime curSheet, "Avg Pace"
    FormatRunnerTime curSheet, "Best Pace"
    AutoFitAllTables curSheet

End Sub
Sub Init()
    Set GarmanWorkBook = ActiveWorkbook
    Set GlobalSheets = New Collection
    SORT_DATA_HEADING_ROW = 2
    
    SORT_DATA_FILE_NAME_COL = 1
    SORT_DATA_DATE_COL = 2
    SORT_DATA_INTERVAL_COL = 3
    SORT_DATA_STEP_TYPE_COL = 4
    SORT_DATA_IMPORT_DATA_COL = SORT_DATA_STEP_TYPE_COL + 1
    
    startingInputRow = SORT_DATA_HEADING_ROW + 1
    totalImportRows = 0

    IMPORT_HEADERS = Array("Time", "Distance", "Avg Pace", "Best Pace", "Avg HR", "Max HR", "Avg Run Cadence", "Max Run Cadence", "Avg Stride Length", "Avg Vertical Oscillation", "Avg Vertical Ratio")
End Sub
Sub createSheet()
    Dim curWS As Worksheet
    
    Dim wsNames As Variant
    Dim i As Integer
    
    wsNames = Array("Sort Data")
    
    For i = LBound(wsNames) To UBound(wsNames)
    
        Set curWS = GarmanWorkBook.Worksheets.add(After:=GarmanWorkBook.Worksheets(GarmanWorkBook.Worksheets.count))
        curWS.Name = wsNames(i)
    
    GlobalSheets.add curWS, wsNames(i)
    Next i
    
End Sub
Sub DisplayHeaders(destinationWS As Worksheet)
    Dim i As Long
        
    destinationWS.Cells(SORT_DATA_HEADING_ROW, SORT_DATA_FILE_NAME_COL).value = "File Name"
    destinationWS.Cells(SORT_DATA_HEADING_ROW, SORT_DATA_DATE_COL).value = "Date"
    destinationWS.Cells(SORT_DATA_HEADING_ROW, SORT_DATA_INTERVAL_COL).value = "Interval"
    destinationWS.Cells(SORT_DATA_HEADING_ROW, SORT_DATA_STEP_TYPE_COL).value = "Step Type"
    
    For i = LBound(IMPORT_HEADERS) To UBound(IMPORT_HEADERS)
        destinationWS.Cells(SORT_DATA_HEADING_ROW, SORT_DATA_IMPORT_DATA_COL + i).value = IMPORT_HEADERS(i)
    Next i

End Sub

Sub loadGarminData(filePath As String, destinationWS As Worksheet)
    Dim srcCSV As Workbook
    Dim srcCSVws As Worksheet
    Dim allowedCols As Variant
    Dim col, csvLastCol, csv, lastRow, destinationColumn As Long
    Dim Header As String
    
    
    Set srcCSV = Workbooks.Open(fileName:=filePath)
    Set srcCSVws = srcCSV.Sheets(1)
    
    csvLastCol = srcCSVws.Cells(1, srcCSVws.Columns.count).End(xlToLeft).Column
    csvLastRow = srcCSVws.Cells(srcCSVws.Rows.count, 1).End(xlUp).Row
    
    'Removes the summary Row'
    If StrComp(srcCSVws.Cells(csvLastRow, 1).value(), "Summary", vbTextCompare) = 0 Then
    
        csvLastRow = csvLastRow - 1
    End If
    
    
    destinationColumn = SORT_DATA_IMPORT_DATA_COL
    
    ' Loop all source CSV columns
    For col = 1 To csvLastCol
        Header = srcCSVws.Cells(1, col).value
        
        'copies over the columns that are in IMPORT HEADERS'
        If IsInArray(Header, IMPORT_HEADERS) Then
            ' Copy the entire column to next available destination col
            
            
            srcCSVws.range(srcCSVws.Cells(2, col), srcCSVws.Cells(csvLastRow, col)).Copy _
        destinationWS.Cells(startingInputRow, destinationColumn)
            destinationColumn = destinationColumn + 1
        End If
    Next col

    srcCSV.Close SaveChanges:=False
    
    totalImportRows = csvLastRow - 1
      
End Sub

Sub addCustomHeaders(selectedSheet As Worksheet)

    selectedSheet.range("A1").value = "Date"
    selectedSheet.range("B1").value = "Type of Work-Out"
    selectedSheet.range("C1").value = "Work Interval Time (s)"
    selectedSheet.range("D1").value = "Work Interval Distance (m)"
    selectedSheet.range("E1").value = "Work Interval Pace (min/km)"
    selectedSheet.range("F1").value = "Rep Break (s)"
        
End Sub
Sub setStepType(selSheet As Worksheet)
        
    Dim threshold As Date
    Dim lastRow, headerRow, curRow, selCol As Long
    Dim cellVal As String
    
    Dim t As Date
    

    
    threshold = TimeValue("07:00:00") '' threshold is 7 mins
    
    selCol = 7
    
    For curRow = startingInputRow To startingInputRow + totalImportRows - 1
        cellVal = selSheet.Cells(curRow, selCol).value
        
        t = CDate(CDbl(cellVal))
        
        If IsDate(t) Then
            If TimeValue(t) < threshold Then
            selSheet.Cells(curRow, SORT_DATA_STEP_TYPE_COL).value = "Run"
            
        Else
            selSheet.Cells(curRow, SORT_DATA_STEP_TYPE_COL).value = "Recovery"
        End If
        
    End If
        
    Next curRow

End Sub

Sub setIntervalNum(selSheet As Worksheet)
    Dim lastRow, curRow, counter As Long
    
    counter = 0
       
    For curRow = startingInputRow To startingInputRow + totalImportRows - 1
    
        If (selSheet.Cells(curRow, SORT_DATA_STEP_TYPE_COL).value = "Run") Then
            counter = counter + 1
        End If
        selSheet.Cells(curRow, SORT_DATA_INTERVAL_COL).value = counter

    Next curRow

End Sub
Sub SetFileNameColumn(selSheet As Worksheet, fileName As String)
    Dim curRow As Long
    
    For curRow = startingInputRow To startingInputRow + totalImportRows - 1
    
        selSheet.Cells(curRow, SORT_DATA_FILE_NAME_COL).value = fileName

    Next curRow

End Sub
Sub SetDateColumn(selSheet As Worksheet, enteredDate As String)
    Dim curRow As Long
  
    For curRow = startingInputRow To startingInputRow + totalImportRows - 1
    
        selSheet.Cells(curRow, SORT_DATA_DATE_COL).value = enteredDate

    Next curRow

End Sub
